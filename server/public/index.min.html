<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Find SNAP-accepting stores near you in NYC with SNAPwise. Get walking directions, health ratings, and AI-powered nutrition coaching. All stores accept food stamps."><title>SNAPwise NYC</title><link rel="dns-prefetch" href="https://unpkg.com"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" media="print" onload='this.media="all"'><link rel="icon" type="image/webp" sizes="64x64" href="media-webp/icons/IconCover64x64.webp"><link rel="icon" type="image/webp" href="media-webp/icons/IconCover180x180.webp"><link rel="apple-touch-icon" sizes="180x180" href="media-webp/icons/IconCover180x180.webp"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preload" href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" as="style" onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap"></noscript><style>:root{--primary:#5AC68A;--primary-dark:#2F9D64;--accent:#A8E6C6;--bg:#F2FBF6;--ink:#0F172A;--muted:#475569;--border:#E2E8F0;--white:#FFFFFF;--safe-top:env(safe-area-inset-top, 0px)}body,html{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}.fonts-loaded .onboard .title-hero,.fonts-loaded header h1{font-family:Fredoka,Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}.container{display:grid;grid-template-rows:auto 1fr;height:100%}header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:var(--white);border-bottom:1px solid var(--border)}header h1{font-size:20px;margin:0;font-weight:700;color:#a6cb52}header .badge{background:var(--accent);color:var(--ink);padding:4px 8px;border-radius:999px;font-size:12px}header .logo{width:30px;height:30px;border-radius:6px}.onboard .logo-wrap img{width:180px;height:180px;border-radius:24px}.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.controls input,.controls select{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--white)}.controls button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer}.controls button:hover{background:var(--primary-dark)}main{display:grid;grid-template-columns:1fr 440px;gap:12px;padding:12px;background:var(--bg)}#map{width:100%;height:calc(100vh - 86px);border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 8px rgba(15,23,42,.06);position:relative}.panel{background:var(--white);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 2px 8px rgba(15,23,42,.06);display:flex;flex-direction:column;height:calc(100vh - 110px);overflow:hidden}body.dark .panel{background:var(--white);border-color:var(--border)}body.dark main{background:var(--bg)}.store{border-bottom:1px solid var(--border);padding:10px 4px}.store:last-child{border-bottom:none}.tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted);white-space:nowrap}.tag.healthy{background:var(--accent);color:var(--ink);border-color:transparent}.tag.snap{background:#f1f5f9;color:var(--ink);border-color:transparent}.tag.rating{color:#fff;border-color:transparent;font-weight:600}.tag.rating.price{color:#fff}.tag.rating.price::after{content:attr(data-unfilled);color:rgba(255,255,255,.4)}.store.flash{background:#fffbe6}.store.selected{background:#fffbe6}.hover-tip{position:fixed;display:none;padding:6px 8px;background:rgba(15,23,42,.92);color:#fff;border-radius:6px;font-size:12px;max-width:280px;z-index:99999999;pointer-events:none;line-height:1.3}.muted{color:var(--muted)}.tabs{display:flex;gap:6px;margin-bottom:8px}.tabs button{flex:1;background:#fff;border:1px solid var(--border);padding:8px;border-radius:10px;cursor:pointer}.tabs button.active{background:var(--accent)}.tab{display:none}.tab.active{display:flex;flex-direction:column;min-height:0}#storesHeader{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}#list{flex:1;overflow:auto}.pager{display:flex;align-items:center;gap:6px}.pager button{background:#fff;border:1px solid var(--border);padding:6px 10px;border-radius:10px;cursor:pointer}.pager select{padding:6px 8px;border:1px solid var(--border);border-radius:10px}.onboard{position:fixed;inset:0;background:rgba(242,251,246,.65);backdrop-filter:saturate(1.1) blur(4px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999999999999999;opacity:1;transition:opacity .5s ease}.onboard.fade-out{opacity:0}.onboard .card{position:relative;z-index:1;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;width:min(720px,92vw);box-shadow:0 8px 30px rgba(15,23,42,.12)}.onboard .title-hero{position:relative;z-index:1;font-size:78.4px;font-weight:900;text-align:center;margin:0 0 16px 0;color:#a6cb52}.onboard .bg-fruit{position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:0}.onboard .fruit{position:absolute;top:-140px;opacity:.25;filter:drop-shadow(0 8px 12px rgba(15,23,42,.18))}@keyframes fruitFall{0%{transform:translateY(-160px) rotate(0);opacity:0}10%{opacity:.25}100%{transform:translateY(calc(100vh + 180px)) rotate(540deg);opacity:.25}}.onboard .card h2{margin:0 0 6px 0}.onboard .card p{margin:0 0 12px 0;color:var(--muted)}.onboard .logo-wrap{display:flex;justify-content:center;margin-bottom:10px}.onboard .logo-wrap img{width:120px;height:120px;border-radius:20px}.goals{display:flex;gap:10px;flex-wrap:wrap}.goal{flex:1 1 160px;border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;transition:box-shadow .15s ease,background .15s ease;display:flex;align-items:center;justify-content:center;text-align:center}.goal:hover{background:var(--bg);box-shadow:0 2px 8px rgba(15,23,42,.06)}.goal.selected{outline:2px solid var(--primary);background:#f3fbf7}.onboard .actions{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}.onboard .field{margin-top:12px}.onboard .field label{display:block;font-weight:600;margin-bottom:6px}.onboard .radio-group{display:flex;gap:12px}.chat{display:flex;flex-direction:column;height:100%}.chat-log{flex:1;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;margin-bottom:8px}#chatLog:empty{display:none}.msg{margin:6px 0}.msg.user{color:#0b5}.msg.assistant{color:#333}.chat-log p{margin:0 0 6px}.chat-log ol,.chat-log ul{margin:6px 0 6px 20px}.chat-log code{background:#f7fafc;padding:0 3px;border-radius:4px}.chat-log pre{background:#f7fafc;padding:8px;border-radius:8px;overflow:auto}.chat-controls{display:flex;gap:6px}.chat-controls input{flex:1;padding:10px;border:1px solid var(--border);border-radius:12px}.tips{font-size:14px;line-height:1.5}.tips-scroll{flex:1;overflow:auto}.tip{background:var(--bg);border-left:4px solid var(--primary);padding:8px 10px;margin:8px 0;border-radius:8px}.info-scroll{max-height:160px;overflow:auto;font-size:12px;line-height:1.35}.tip-cat{margin:8px 0;border:1px solid var(--border);border-radius:10px;background:#fff}.tip-cat>summary{cursor:pointer;list-style:none;padding:10px 12px;font-weight:600;display:flex;align-items:center;justify-content:space-between}.tip-cat>summary:hover{background:var(--bg)}.tip-cat[open]>summary{background:var(--bg)}.tip-cat>summary::-webkit-details-marker{display:none}.tip-cat>summary::after{content:'▸';color:var(--muted);margin-left:8px}.tip-cat[open]>summary::after{content:'▾'}.tip-list{padding:8px 12px 12px 12px}.tracker-section{display:grid;gap:10px}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}.legend{position:absolute;left:12px;bottom:12px;background:var(--white);border:1px solid var(--border);border-radius:12px;padding:8px 10px;box-shadow:0 2px 8px rgba(15,23,42,.06);z-index:1000;max-width:260px}.legend h4{margin:0 0 6px 0;font-size:12px;font-weight:700;color:var(--muted)}.legend-section{margin-top:6px}.legend-item{display:flex;align-items:center;gap:8px;margin:4px 0}.swatch{width:12px;height:12px;border-radius:4px;border:1px solid var(--border)}.shape{width:12px;height:12px}.shape.circle{border-radius:50%;border:2px solid #64748b}.shape.diamond{width:10px;height:10px;border:2px solid #64748b;transform:rotate(45deg)}.diamond-shape{display:block;transform:rotate(45deg);border-radius:4px}.legend.collapsed #legendBody{display:none}.legend.collapsed #legendModeControls{display:none}.legend.collapsed h4{margin:0}.legend-toggle{background:0 0;border:none;padding:0;width:20px;height:20px;cursor:pointer;color:var(--muted)}.legend-toggle::after{content:'▾';font-size:14px;line-height:1}.legend.collapsed .legend-toggle::after{content:'▸'}.legend-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}.legend.collapsed .legend-header{margin-bottom:0}.btn{background:var(--white);color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer;transition:background .15s ease,box-shadow .15s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px}.btn:hover{box-shadow:0 2px 6px rgba(15,23,42,.08)}.btn-primary{background:var(--primary);color:#fff;border-color:transparent}.btn-primary:hover{background:var(--primary-dark)}.btn-ghost{background:0 0}.btn-primary:disabled,.btn-primary[disabled],.btn:disabled,.btn[disabled]{background:#e2e8f0;color:#94a3b8;border-color:#e2e8f0;cursor:not-allowed;box-shadow:none}.btn-icon{padding:8px 10px;border-radius:10px}.icon-btn{background:0 0;border:none;padding:0 4px;font-size:12px;line-height:1;cursor:pointer;vertical-align:baseline}.icon-btn:hover{background:var(--bg)}input,select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--white)}:root{--sb-thumb:rgba(100,116,139,0.55);--sb-thumb-hover:rgba(100,116,139,0.8);--sb-track:transparent}body.dark{--sb-thumb:rgba(148,163,184,0.65);--sb-thumb-hover:rgba(203,213,225,0.85);--sb-track:transparent}#list,#tab-tracker,.chat-log,.panel,.tips-scroll{-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--sb-thumb) transparent}#list::-webkit-scrollbar,#tab-tracker::-webkit-scrollbar,.chat-log::-webkit-scrollbar,.panel::-webkit-scrollbar,.tips-scroll::-webkit-scrollbar{width:6px;height:6px}#list::-webkit-scrollbar-track,#tab-tracker::-webkit-scrollbar-track,.chat-log::-webkit-scrollbar-track,.panel::-webkit-scrollbar-track,.tips-scroll::-webkit-scrollbar-track{background:0 0!important;border-radius:8px}#list::-webkit-scrollbar-thumb,#tab-tracker::-webkit-scrollbar-thumb,.chat-log::-webkit-scrollbar-thumb,.panel::-webkit-scrollbar-thumb,.tips-scroll::-webkit-scrollbar-thumb{background:var(--sb-thumb);border-radius:8px;border:2px solid transparent;background-clip:padding-box}#list::-webkit-scrollbar-thumb:hover,#tab-tracker::-webkit-scrollbar-thumb:hover,.chat-log::-webkit-scrollbar-thumb:hover,.panel::-webkit-scrollbar-thumb:hover,.tips-scroll::-webkit-scrollbar-thumb:hover{background:var(--sb-thumb-hover)}.range-wrap{position:relative;width:90%;margin:0 auto}.range-wrap input[type=range]{width:100%;display:block;accent-color:var(--primary)}.range-labels{display:none}#healthy,#pageSize,#radius,#sortBy,#unitSystem{cursor:pointer}.theme-switch,.theme-toggle,.theme-toggle img{cursor:pointer}#boroughSelect{cursor:pointer}#maxResults{cursor:pointer}#maxResultsMobile{cursor:pointer}.onboard .radio-group input,.onboard .radio-group label{cursor:pointer}.tracker-card{background:var(--white);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(15,23,42,.04)}.section-title{font-weight:600;margin:0 0 8px 0}.disclaimer{margin-left:auto;font-size:12px;color:var(--muted);white-space:normal;text-align:right;overflow:visible;text-overflow:clip}.disclaimer-narrow{display:none}.cap-note{font-size:11px;color:var(--muted);margin-top:2px}.warning{background:var(--accent);border:1px solid var(--primary);border-radius:8px;padding:12px;margin:8px 0;color:var(--ink);font-weight:500}.warning .warning-icon{font-size:16px;margin-right:8px}.settings{position:relative;z-index:999999}.settings-mobile{display:none;position:fixed;top:12px;right:12px;z-index:999999999}.settings-mobile .settings-menu{position:fixed;right:20px;top:calc(var(--header-h,64px) - 75px);z-index:999999999}.settings-mobile.is-open .settings-menu{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}.settings-mobile>summary{list-style:none}.settings-mobile>summary::-webkit-details-marker{display:none}.settings>summary{list-style:none}.settings>summary::-webkit-details-marker{display:none}.settings-menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--white);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,.12);padding:10px;min-width:260px;z-index:999999;opacity:0;transform:translateY(-6px) scale(.98);transform-origin:top right;transition:opacity .18s ease,transform .18s ease;pointer-events:none}.settings.is-open .settings-menu{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}@media (prefers-reduced-motion:reduce){.settings-menu{transition:none}}.settings-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 0}.settings-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 0}.theme-toggle{display:flex;align-items:center;justify-content:center;gap:4px;padding:6px 0}.theme-toggle img{width:16px;height:16px}.theme-switch{position:relative;width:50px;height:28px;background:#e2e8f0;border:1px solid var(--border);border-radius:999px;display:inline-flex;align-items:center;vertical-align:middle;padding:0}.theme-switch input{display:none}.theme-knob{position:absolute;top:3px;left:3px;width:22px;height:22px;background:var(--white);border:1px solid var(--border);border-radius:999px;transition:left .2s ease,background .2s ease}.theme-switch input:checked+.theme-knob{left:25px}body.dark .theme-switch{background:#1e293b;border-color:var(--border)}body.dark .theme-knob{background:#0b1220;border-color:#475569}body.dark{--primary:#5AC68A;--primary-dark:#2F9D64;--accent:#0A3D2A;--bg:#0B1220;--ink:#E5E7EB;--muted:#94A3B8;--border:#334155;--white:#0F172A}body.dark .hover-tip{background:rgba(2,6,23,.92)}body.dark .onboard .card{background:var(--white)}body.dark .onboard{background:rgba(11,18,32,.75)}body.dark .chat-log code,body.dark .chat-log pre{background:#0f172a;color:var(--ink)}body.dark .msg.assistant{color:var(--ink)}body.dark input,body.dark select,body.dark textarea{background:var(--white);color:var(--ink);border-color:var(--border)}body.dark input::placeholder,body.dark textarea::placeholder{color:var(--muted)}body.dark .tabs button{background:var(--white);color:var(--ink);border-color:var(--border)}body.dark .tabs button.active{background:var(--accent);color:var(--ink)}body.dark .pager button{background:var(--white);color:var(--ink);border-color:var(--border)}body.dark .tip-cat{background:var(--white);border-color:var(--border)}body.dark .tip-cat>summary{color:var(--ink)}body.dark .tip-cat>summary:hover,body.dark .tip-cat[open]>summary{background:var(--bg)}body.dark .tip-list{color:var(--ink)}body.dark .tip{background:var(--bg);color:var(--ink);border-left-color:var(--primary)}body.dark .goal{background:var(--white);color:var(--ink);border-color:var(--border)}body.dark .goal:hover{background:var(--bg)}body.dark .goal.selected{outline:2px solid var(--primary);background:rgba(90,198,138,.14);color:var(--ink)}body.dark .store.selected{background:rgba(90,198,138,.14)}body.dark .store.flash{background:rgba(90,198,138,.14)}body.dark .tag.snap{background:#1e293b;color:var(--ink);border-color:transparent}body.dark .leaflet-popup-content-wrapper{background:var(--white);color:var(--ink);border:1px solid var(--border)}body.dark .leaflet-popup-tip{background:var(--white);border:1px solid var(--border)}body.dark .leaflet-popup-close-button{color:var(--ink)}@media (max-width:1200px){main{grid-template-columns:1fr 360px}}@media (max-width:1250px){.disclaimer-wide{display:none}.disclaimer-narrow{display:block}}@media (max-width:900px){body,html{overflow:hidden;height:100%;overscroll-behavior:none}header{position:sticky;top:0;z-index:999999}header{flex-wrap:wrap;align-items:center}.disclaimer{display:none}main{grid-template-columns:1fr;grid-template-rows:auto 1fr;padding:0}#map{height:calc(100dvh - var(--header-h,64px));margin-top:0;width:100vw;border:none;border-radius:0;box-shadow:none}.panel{position:fixed;left:0;right:0;bottom:0;margin:0;border-radius:16px 16px 0 0;height:var(--sheet-height,calc(.48 * (100dvh - var(--header-h,64px) - 22px)));max-height:none;overflow:auto;-webkit-overflow-scrolling:touch;z-index:9999990;box-shadow:0 -6px 20px rgba(15,23,42,.12);transition:height .25s ease}.tabs{position:sticky;top:0;background:var(--white);z-index:2}.sheet-handle{position:relative;padding:5px 0;margin:-4px auto 6px auto;touch-action:none;-webkit-user-select:none;user-select:none;cursor:grab}.sheet-handle::after{content:"";display:block;width:clamp(48px,18vw,80px);height:6px;border-radius:999px;background:var(--border);margin:0 auto}.sheet-handle:active{cursor:grabbing}#tab-tracker{flex:1 1 auto;overflow:auto;-webkit-overflow-scrolling:touch}header .logo{order:0}header h1{order:1}header .settings{order:2;margin-left:auto}header .controls{order:3;flex:1 1 100%;display:flex;flex-wrap:wrap;gap:6px}header .settings{display:none}.settings-mobile{display:block}header .controls button{text-align:center;justify-content:center}#respLenGroupMobile{display:flex;width:90%;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden;justify-content:center;background:var(--white)}#respLenGroupMobile button{flex:1 1 0;min-width:80px;border:none!important;border-radius:0;height:36px;padding:8px 8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:var(--white);color:var(--ink);font-size:14px;cursor:pointer;transition:background-color .2s ease;box-sizing:border-box;text-align:center;display:flex;align-items:center;justify-content:center}#respLenGroupMobile button:last-child{border-right:none!important}#respLenGroupMobile button.btn-primary{background:var(--primary)!important;color:var(--white)!important;border:none!important}#zip{flex:1 1 160px;min-width:0}#radius{flex:0 0 92px}#healthy{flex:0 0 150px}#locBtn,#searchBtn{flex:1 1 auto}}@media (max-width:600px){header{padding:10px 12px}header .logo{width:24px;height:24px}header h1{font-size:22px}header .controls{gap:4px}#zip{flex:1 1 160px;min-width:0}#radius{flex:0 0 80px}#healthy{flex:0 0 120px}.controls input,.controls select{padding:6px 8px;font-size:14px}.controls button{padding:7px 10px;font-size:14px}.tabs button{padding:6px;font-size:12px}.legend{left:auto;right:12px;top:12px;bottom:auto;padding:4px 6px;z-index:900}.legend h4{font-size:11px;margin:0 0 4px 0}.legend-section{margin-top:4px}.legend-item{margin:2px 0;gap:6px}.legend-header{margin-bottom:4px;gap:6px}.onboard{align-items:stretch;justify-content:flex-start;padding:max(12px,env(safe-area-inset-top)) 12px max(16px,env(safe-area-inset-bottom));height:100svh;overflow:auto}.onboard .title-hero{font-size:clamp(36px,8vw,48px);margin:8px 0 10px 0}.onboard .logo-wrap img{width:72px;height:72px}.onboard .card{width:min(90vw,520px);padding:12px;margin:0 auto;max-height:calc(100svh - 120px);overflow:auto;box-sizing:border-box}.onboard .card h2{font-size:clamp(18px,5.8vw,24px);line-height:1.25;margin:6px 0 8px 0}.onboard .bg-fruit{display:block}.goals{display:grid;grid-template-columns:1fr;gap:6px}.goal{min-height:40px;padding:8px 10px;border-radius:10px;font-size:clamp(13px,3.8vw,15px)}.onboard .field label{font-size:14px}.onboard .radio-group{gap:10px}.onboard .actions{flex-wrap:wrap}.onboard .actions .btn{flex:1 1 120px;padding:10px 12px}.grid2{grid-template-columns:1fr}.chat-controls{flex-wrap:wrap}.chat-controls input{flex:1 1 100%}.chat-controls .btn{flex:1 1 auto}}@media (max-width:480px){.goals{grid-template-columns:1fr}.onboard .card{width:min(88vw,520px)}.goal{min-height:38px;padding:8px;font-size:clamp(12px,3.6vw,14px)}.onboard .actions .btn{flex:1 1 120px}#zip{flex:1 1 140px}#radius{flex:0 0 76px}#healthy{flex:0 0 110px}}.store-search-container{margin-bottom:12px;display:block}.store-search-input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--white);font-size:14px;transition:border-color .2s ease;box-sizing:border-box}.store-search-input:focus{outline:0;border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,198,138,.1)}.store-search-input::placeholder{color:var(--muted)}@media (max-width:900px){.store-search-container{display:block!important}}@media (max-width:900px){.healthy-store-info{display:none!important}}</style></head><body><div class="container"><header><img src="media-webp/icons/IconCover180x180.webp" alt="App icon" class="logo"><h1>SNAPwise NYC</h1><div class="controls"><input id="zip" placeholder="Enter ZIP (e.g., 10452)" maxlength="5" oninput='this.value=this.value.replace(/[^0-9]/g,"").slice(0,5)'><select id="radius"><option value="804" selected="selected">0.5 mi</option><option value="1609">1 mi</option><option value="3219">2 mi</option><option value="8046">5 mi</option></select><select id="healthy"><option value="any">Any</option><option value="true">Only Known Healthy</option></select><button id="searchBtn" class="btn btn-primary">Search</button><button id="locBtn" class="btn btn-ghost">Use My Location</button></div><div class="disclaimer disclaimer-wide">*Please take all nutritional and dietary advice with caution.</div><div class="disclaimer disclaimer-narrow">*Please take all nutritional and<br>dietary advice with caution.</div><details class="settings" id="settings"><summary class="btn btn-primary btn-icon" title="Settings"><img src="media-webp/Settings.webp" alt="Settings" style="width:18px;height:18px"></summary><div class="settings-menu"><div style="position:absolute;top:6px;right:10px;font-size:10px;font-style:italic;color:var(--muted);pointer-events:none">v1.07</div><div class="muted" style="font-weight:600;margin-bottom:6px;text-align:center">Settings</div><div class="settings-row"><div class="theme-toggle" style="flex:0 0 auto;justify-content:flex-start"><img src="media-webp/Sun.webp" alt="Light"><label class="theme-switch" for="toggleDark" style="margin:0 4px"><input id="toggleDark" type="checkbox"><span class="theme-knob"></span></label><img src="media-webp/Moon.webp" alt="Dark"></div><label class="units-select" style="display:flex;align-items:center;gap:6px;white-space:nowrap"><span class="muted" style="font-size:12px">Units</span><select id="unitSystem"><option value="mi">mi</option><option value="km">km</option></select></label></div><div class="settings-row" style="flex-direction:column;align-items:stretch;gap:4px"><div class="muted" style="font-size:12px;text-align:center">Coach Response Length</div><div class="btn-group" id="respLenGroup" role="group" aria-label="Coach response length" style="display:flex;width:90%;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden;justify-content:center"><button type="button" data-val="concise" class="btn" style="flex:1 1 0;border:none;border-right:1px solid var(--border);border-radius:0">Concise</button><button type="button" data-val="default" class="btn" style="flex:1 1 0;border:none;border-right:1px solid var(--border);border-radius:0">Default</button><button type="button" data-val="comprehensive" class="btn" style="flex:1 1 0;border:none;border-radius:0">Extensize</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch;gap:6px"><div class="muted" style="font-size:12px;text-align:center">Max Store Results</div><div style="display:flex;justify-content:center"><select id="maxResults" style="min-width:140px"><option value="100">100</option><option value="200">200</option><option value="500">500</option><option value="Unlimited">Unlimited</option></select></div><div style="text-align:center;font-size:10px;font-style:italic;color:var(--muted);margin-top:2px">*Unlimited is experimental and not recommended</div></div><button class="btn" id="returnHome" style="width:100%;justify-content:center;margin-top:12px">Return to Home Screen</button><div style="text-align:center;font-size:10px;font-style:italic;color:var(--muted);margin-top:4px">mising26@cgps.org for inquiries</div></div></details></header><details class="settings-mobile" id="settings-mobile"><summary class="btn btn-primary btn-icon" title="Settings"><img src="media-webp/Settings.webp" alt="Settings" style="width:18px;height:18px"></summary><div class="settings-menu"><div style="position:absolute;top:6px;right:10px;font-size:10px;font-style:italic;color:var(--muted);pointer-events:none">v1.05</div><div class="muted" style="font-weight:600;margin-bottom:6px;text-align:center">Settings</div><div class="settings-row"><div class="theme-toggle" style="flex:0 0 auto;justify-content:flex-start"><img src="media-webp/Sun.webp" alt="Light"><label class="theme-switch" for="toggleDarkMobile" style="margin:0 4px"><input id="toggleDarkMobile" type="checkbox"><span class="theme-knob"></span></label><img src="media-webp/Moon.webp" alt="Dark"></div><label class="units-select" style="display:flex;align-items:center;gap:6px;white-space:nowrap"><span class="muted" style="font-size:12px">Units</span><select id="unitSystemMobile"><option value="mi">mi</option><option value="km">km</option></select></label></div><div class="settings-row" style="flex-direction:column;align-items:stretch;gap:4px"><div class="muted" style="font-size:12px;text-align:center">Coach Response Length</div><div class="btn-group" id="respLenGroupMobile" role="group" aria-label="Coach response length" style="display:flex;width:90%;margin:0 auto;border:1px solid var(--border);border-radius:12px;overflow:hidden;justify-content:center"><button type="button" data-val="concise" class="btn" style="flex:1 1 0;border:none;border-right:1px solid var(--border);border-radius:0">Concise</button><button type="button" data-val="default" class="btn" style="flex:1 1 0;border:none;border-right:1px solid var(--border);border-radius:0">Default</button><button type="button" data-val="comprehensive" class="btn" style="flex:1 1 0;border:none;border-radius:0">Extensize</button></div></div><div class="settings-row" style="flex-direction:column;align-items:stretch;gap:6px"><div class="muted" style="font-size:12px;text-align:center">Max Store Results</div><div style="display:flex;justify-content:center"><select id="maxResultsMobile"><option value="100">100</option><option value="200">200</option><option value="500">500</option><option value="Unlimited">Unlimited</option></select></div><div style="text-align:center;font-size:10px;font-style:italic;color:var(--muted);margin-top:2px">*Unlimited is experimental and not recommended</div></div><button class="btn" id="returnHomeMobile" style="width:100%;justify-content:center;margin-top:12px">Return to Home Screen</button><div style="text-align:center;font-size:10px;font-style:italic;color:var(--muted);margin-top:4px">mising26@cgps.org for inquiries</div></div></details><main><div id="map"><div class="legend" id="legend"></div></div><aside class="panel"><div class="sheet-handle" aria-hidden="true"></div><div class="tabs"><button data-tab="stores" class="active">Stores</button><button data-tab="coach">Coach</button><button data-tab="tracker">Tracker</button><button data-tab="tips">Tips</button></div><div id="tab-stores" class="tab active"><div class="store-search-container"><input id="storeSearch" type="text" placeholder="Search for a specific store..." class="store-search-input"></div><div id="storesHeader"><div class="muted" id="storesSummary">0 results</div><div class="pager"><select id="sortBy" title="Sort by"><option value="distance" selected="selected">Distance</option><option value="health">Health</option><option value="price">Price</option></select><button id="prevPage" class="btn">Prev</button><span id="pageInfo" class="muted">1 / 1</span><button id="nextPage" class="btn">Next</button><select id="pageSize"><option value="25">25</option><option value="50" selected="selected">50</option><option value="100">100</option></select></div></div><details class="healthy-store-info" style="margin:4px 0 8px 0"><summary class="muted" style="cursor:pointer">What is a "Known Healthy" store?</summary><div class="tip info-scroll" style="margin-top:6px"><strong>Bodegas & Grocery Stores Receiving Recognition from Borough President's Office</strong><br>Each year, bodegas and grocery stores located in and around Action Center catchment areas participate in the Shop Healthy NYC program's Retail Challenge to increase (1) availability of healthier foods, such as low-sodium canned goods, healthier snacks and deli options; (2) promotion of healthier foods by posting Shop Healthy marketing materials for healthier foods and removing unhealthy advertising from the front door; and (3) visibility of healthier foods by placing them in more prominent locations, such as placing produce at the checkout counter or near the front entrance of the store, and water and other low-calorie drinks at eye-level. Stores that have implemented all of the program's criteria at the conclusion of the Retail Challenge, and maintain them for at least one month, receive a recognition award from the Borough President's Office to acknowledge their efforts and dedication to make the healthy choice, the easier choice for their communities.<br><br>This is a manually compiled list of stores, which is based on data collected through implementation checklists; these are forms completed by Shop Healthy staff as part of store observations that track whether each criteria has been met. At this time, the program does not have processes in place to ensure that stores maintain the changes past one-month.</div></details><div id="list"></div></div><div id="tab-coach" class="tab"><div class="chat"><div id="chatLog" class="chat-log"></div><div class="chat-controls"><input id="chatInput" placeholder="Ask Health Coach..."><button id="chatSend" class="btn btn-primary">Send</button><button id="chatClear" class="btn btn-ghost" title="Clear chat">Clear chat</button></div></div></div><div id="tab-tracker" class="tab"><div class="tracker-section"><div class="tracker-card"><div class="section-title">Daily targets</div><div class="grid2"><div><label class="muted">Calories</label><input id="calTarget" type="number" min="800" max="4000" placeholder="..."></div><div><label class="muted">Protein (g)</label><input id="proteinTarget" type="number" min="20" max="300" placeholder="..."></div></div><div style="text-align:center;font-size:10px;font-style:italic;color:var(--muted);margin-top:12px">According to the U.S. Food and Drug Administration, a 2,000-calorie daily diet is used as the basis for general nutrition recommendations.</div></div><div class="tracker-card"><div class="section-title">Log a meal</div><div class="grid2"><input id="mealName" placeholder="Food name"> <input id="mealCals" type="number" placeholder="Calories"></div><div class="grid2" style="margin-top:6px"><input id="mealProtein" type="number" placeholder="Protein (g)"><button id="addMeal" class="btn btn-primary">Add meal</button></div></div><div class="tracker-card"><div class="section-title">Today</div><div id="todayTotals" style="margin-bottom:6px"></div><div id="mealList"></div><div style="display:flex;gap:8px;justify-content:space-between;margin-top:8px"><button id="resetLog" class="btn btn-ghost">Reset log</button><button id="reviewDiet" class="btn"><img id="reviewDietIcon" src="media-webp/Magnifying Glass Light.webp" alt="Search" style="width:14px;height:14px;vertical-align:middle;margin-right:6px">Review Diet</button></div></div></div></div><div id="tab-tips" class="tab"><div class="tips tips-scroll"><details class="tip-cat"><summary>Weight Loss</summary><div class="tip-list"><div class="tip"><strong>Protein first:</strong>Aim for a protein source every meal (eggs, tuna, beans, yogurt) to stay full longer.</div><div class="tip"><strong>Volume foods:</strong>Load half the plate with high‑fiber, low‑cal veggies (frozen is great and cheap).</div><div class="tip"><strong>Drink swap:</strong>Replace sugary drinks with water or seltzer; save 150–300 calories per bottle.</div><div class="tip"><strong>Smart snacks:</strong>Keep fruit, nuts (small handful), or yogurt; avoid chips near the checkout trap.</div><div class="tip"><strong>Plate timing:</strong>Eat slow; a 10–15 minute pause helps your brain register fullness.</div><div class="tip"><strong>Simple breakfasts:</strong>Oats + peanut butter + banana, or eggs + beans + salsa.</div></div></details><details class="tip-cat"><summary>Affordable Proteins</summary><div class="tip-list"><div class="tip"><strong>Eggs:</strong>Versatile, cheap, 6–7g protein each. Boil a dozen for grab‑and‑go.</div><div class="tip"><strong>Canned tuna/chicken:</strong>$1–2 a can; mix with beans or greens.</div><div class="tip"><strong>Beans & lentils:</strong>Dry or canned; fiber + protein for pennies per serving.</div><div class="tip"><strong>Greek yogurt:</strong>Large tubs are best value; add fruit/oats for snacks.</div><div class="tip"><strong>Peanut butter:</strong>2 tbsp ≈ 7–8g protein; pair with oats, toast, apples.</div></div></details><details class="tip-cat"><summary>Quick Meals (5–10 minutes)</summary><div class="tip-list"><div class="tip"><strong>Tuna wrap:</strong>Tuna + light mayo + salsa + lettuce in tortilla.</div><div class="tip"><strong>Egg stir‑up:</strong>Scramble eggs with frozen veg; finish with soy or salsa.</div><div class="tip"><strong>Bean bowl:</strong>Rice + black beans + corn + salsa + yogurt.</div><div class="tip"><strong>Microwave oats:</strong>Oats + water + PB + banana in 2–3 minutes.</div><div class="tip"><strong>Yogurt parfait:</strong>Greek yogurt + fruit + oats; add cinnamon.</div></div></details><details class="tip-cat"><summary>Healthy Shopping</summary><div class="tip-list"><div class="tip"><strong>Shop a list:</strong>Write 5–10 items and stick to them.</div><div class="tip"><strong>Unit price:</strong>Compare price per oz/lb; bigger isn't always cheaper.</div><div class="tip"><strong>Frozen produce:</strong>Often cheaper, less waste, same nutrients.</div><div class="tip"><strong>Store brands:</strong>Choose generic for rice, pasta, milk, spices.</div><div class="tip"><strong>Seasonal buys:</strong>In‑season fruit/veg are cheaper and taste better.</div></div></details><details class="tip-cat"><summary>Meal Prep & Leftovers</summary><div class="tip-list"><div class="tip"><strong>Cook once, eat twice:</strong>Double rice/beans/chicken for the week.</div><div class="tip"><strong>Base + toppings:</strong>Prep rice and rotate proteins/sauces daily.</div><div class="tip"><strong>Freeze extras:</strong>Soup, chili, cooked meat freeze well; label dates.</div><div class="tip"><strong>Leftover refresh:</strong>Add eggs/tortilla to transform last night's meal.</div><div class="tip"><strong>Snack boxes:</strong>Portion nuts, fruit, yogurt for grab‑and‑go.</div></div></details><details class="tip-cat"><summary>Diabetes‑Friendly</summary><div class="tip-list"><div class="tip"><strong>Plate method:</strong>Half veg, quarter protein, quarter starch.</div><div class="tip"><strong>Fiber first:</strong>Beans, oats, apples help slow sugar spikes.</div><div class="tip"><strong>Smart drinks:</strong>Water, seltzer, unsweet tea; avoid sugary beverages.</div><div class="tip"><strong>Pair carbs:</strong>Apples + PB, crackers + tuna, yogurt + oats.</div><div class="tip"><strong>Portions:</strong>Measure rice/pasta at first to learn serving sizes.</div></div></details><details class="tip-cat"><summary>Low‑Sodium Swaps</summary><div class="tip-list"><div class="tip"><strong>Rinse beans:</strong>Cuts sodium by ~30–40%.</div><div class="tip"><strong>Low‑sodium picks:</strong>Broth, beans, canned veg when possible.</div><div class="tip"><strong>Flavor without salt:</strong>Garlic, onion, chili, vinegar, lemon, herbs.</div><div class="tip"><strong>Watch sauces:</strong>Soy, BBQ, dressings add up; use lightly.</div><div class="tip"><strong>Frozen veg:</strong>Usually no salt added; quick and healthy.</div></div></details><details class="tip-cat"><summary>Vegetarian on a Budget</summary><div class="tip-list"><div class="tip"><strong>Protein trio:</strong>Beans, lentils, eggs cover protein cheaply.</div><div class="tip"><strong>Meatless chili:</strong>Beans + tomatoes + corn + spices.</div><div class="tip"><strong>Tofu basics:</strong>Pan‑sear with soy/garlic; add frozen veg and rice.</div><div class="tip"><strong>PB oatmeal:</strong>Protein + fiber breakfast for cents/serving.</div><div class="tip"><strong>Frozen mixes:</strong>Pre‑cut stir‑fry blends save time and money.</div></div></details><details class="tip-cat"><summary>Microwave & No‑Cook</summary><div class="tip-list"><div class="tip"><strong>Mug omelet:</strong>Eggs + veg + cheese; 90 seconds.</div><div class="tip"><strong>Bean quesadilla:</strong>Tortilla + beans + cheese; pan or microwave.</div><div class="tip"><strong>No‑cook wraps:</strong>Hummus + veg + leftover meat.</div><div class="tip"><strong>Overnight oats:</strong>Oats + milk + PB + banana in a jar.</div><div class="tip"><strong>Ready rice + tuna:</strong>Microwave rice, mix with tuna and salsa.</div></div></details><details class="tip-cat"><summary>Kids & Family</summary><div class="tip-list"><div class="tip"><strong>Build‑your‑own:</strong>Taco bowls with rice, beans, cheese, salsa, veg.</div><div class="tip"><strong>Snack swaps:</strong>Fruit + yogurt instead of cookies; popcorn over chips.</div><div class="tip"><strong>Helper jobs:</strong>Let kids wash veg, stir, or portion snacks.</div><div class="tip"><strong>Color game:</strong>Aim for 3 colors on the plate each meal.</div><div class="tip"><strong>Water first:</strong>Drink water before juice or soda.</div></div></details><details class="tip-cat"><summary>Food Safety & Storage</summary><div class="tip-list"><div class="tip"><strong>FIFO:</strong>First in, first out—use older items first.</div><div class="tip"><strong>Label leftovers:</strong>Date containers; 3–4 days in the fridge.</div><div class="tip"><strong>Safe thaw:</strong>Fridge or cold water bath, not the counter.</div><div class="tip"><strong>Cool fast:</strong>Store hot foods in shallow containers.</div><div class="tip"><strong>Reheat hot:</strong>Warm leftovers to steaming (≥165°F/74°C).</div></div></details><details class="tip-cat"><summary>SNAP & Pantry Tips</summary><div class="tip-list"><div class="tip"><strong>Staples first:</strong>Beans, rice, oats, eggs, frozen veg stretch budgets.</div><div class="tip"><strong>Pantry nights:</strong>Plan 1–2 "pantry meals" weekly to use what you have.</div><div class="tip"><strong>Bulk smart:</strong>Only buy bulk if you can store it and will use it.</div><div class="tip"><strong>Local pantries:</strong>Ask for produce/meat days; arrive early.</div><div class="tip"><strong>Double‑duty foods:</strong>Buy items that work across breakfast/lunch/dinner.</div></div></details><details class="tip-cat"><summary>Spending Less on Food</summary><div class="tip-list"><div class="tip"><strong>Unit price:</strong>Compare price per ounce; bigger isn't always cheaper on brand-name bundles.</div><div class="tip"><strong>Staples:</strong>Oats, rice, beans, eggs, frozen veg, canned fish stretch meals for less.</div><div class="tip"><strong>Plan 3 meals:</strong>Rotate 2–3 cheap, filling meals each week to cut impulse buys.</div><div class="tip"><strong>Store brands:</strong>Buy generic for basics (rice, pasta, milk, spices) with similar quality.</div><div class="tip"><strong>Leftovers plan:</strong>Cook once, eat twice. Make extra rice/beans to reuse all week.</div><div class="tip"><strong>Freezer friend:</strong>Freeze bread, meats, and leftovers to avoid waste.</div></div></details><details class="tip-cat"><summary>Manipulative Sales Tactics</summary><div class="tip-list"><div class="tip"><strong>Bundle trap:</strong>Value meals add sides/soda you didn't want. Order items separately.</div><div class="tip"><strong>Eye-level tricks:</strong>High‑calorie snacks live at eye level. Scan lower shelves for better options.</div><div class="tip"><strong>BOGO bait:</strong>"Buy one get one" doubles spend and calories; only buy if you needed one.</div><div class="tip"><strong>Limited time:</strong>"Today only" signs push urgency. Pause and check your list first.</div><div class="tip"><strong>Checkout gauntlet:</strong>Avoid the candy rack by using self‑checkout when possible.</div><div class="tip"><strong>Fancy packaging:</strong>"Protein," "keto," or "natural" labels don't guarantee healthy.</div></div></details><details class="tip-cat"><summary>Common Misconceptions</summary><div class="tip-list"><div class="tip"><strong>"Healthy is expensive":</strong>Frozen veg, eggs, beans, and oats are low‑cost nutrient staples.</div><div class="tip"><strong>"Salads are always healthy":</strong>Dressings/toppings can double calories; choose light dressing, protein.</div><div class="tip"><strong>"Carbs are bad":</strong>Whole grains and beans help fullness and budget; watch portions, not all carbs.</div><div class="tip"><strong>"Snacking ruins progress":</strong>Planned high‑protein snacks can prevent overeating later.</div><div class="tip"><strong>"All fast food is bad":</strong>Grilled chicken, small chili, baked potato, or side salads can work.</div><div class="tip"><strong>"You need supplements":</strong>Food first; only add vitamins if a clinician recommends.</div></div></details></div></div></aside></main></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" fetchpriority="high"></script><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" fetchpriority="high"></script><script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js" fetchpriority="high"></script><script>const API_BASE = (location.protocol === 'file:') ? 'http://localhost:3000' : '';
const DEFAULT_ZOOM=16;"fonts"in document?document.fonts.load("400 16px Fredoka").then((()=>{document.body.classList.add("fonts-loaded")})).catch((()=>{})):setTimeout((()=>{document.body.classList.add("fonts-loaded")}),1e3);const map=L.map("map").setView([40.758,-73.985],DEFAULT_ZOOM);initializeDefaultLocation().then((()=>{map.setView([currentLat,currentLng],DEFAULT_ZOOM),queryStores(currentLat,currentLng)}));const tilesLight=L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}@1x.webp",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors &copy; CARTO"}),tilesDark=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}@1x.webp",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors &copy; CARTO"});let currentBaseLayer=null;function updateMapTheme(){try{const e=document.body.classList.contains("dark")?tilesDark:tilesLight;currentBaseLayer&&currentBaseLayer!==e&&map.removeLayer(currentBaseLayer),map.hasLayer(e)||e.addTo(map),currentBaseLayer=e}catch{}}updateMapTheme(),renderLegend(),function(){const e=document.querySelector("header");function t(){try{const t=e?e.getBoundingClientRect().height:64;document.documentElement.style.setProperty("--header-h",Math.round(t)+"px")}catch{}}t(),window.addEventListener("resize",t),setTimeout(t,200)}(),function(){if(window.matchMedia("(min-width: 901px)").matches)return;const e=document.querySelector(".panel");if(!e)return;let t=0,n=0,a=!1;const o=0;function r(){return Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)}function i(){try{const e=window.visualViewport;if(e&&"number"==typeof e.offsetTop)return Math.max(0,Math.round(e.offsetTop))}catch{}return parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--safe-top"))||0}function s(){try{return Math.max(0,Math.round(document.querySelector("header")?.getBoundingClientRect().height||64))}catch{return 64}}function c(){const e=window.visualViewport?.height?Math.round(window.visualViewport.height):r(),t=Math.max(0,e-(i()+s()+22))/e;return Math.min(.92,Math.max(.5,t))}function l(){const e=window.visualViewport?.height?Math.round(window.visualViewport.height):r(),t=.48*Math.max(0,e-(i()+s()-0+22))/e;return Math.max(o+.05,Math.min(.65,t))}let d=l(),u=c();function m(t){const n=Math.max(o,Math.min(u,t));document.documentElement.style.setProperty("--sheet-height",Math.round(100*n)+"vh"),function(t){const n=t<=o+.005;if(e.classList.toggle("sheet-locked",n),n){e.style.overflow="hidden";try{e.scrollTop=0}catch{}}else e.style.overflow="auto"}(n);try{map&&map.invalidateSize&&setTimeout((()=>map.invalidateSize()),150)}catch{}}m(d);const p=e.querySelector(".sheet-handle")||e;function g(o){a=!0,t=o.touches?o.touches[0].clientY:o.clientY,n=e.getBoundingClientRect().height,document.body.style.userSelect="none"}function h(e){if(!a)return;const o=e.touches?e.touches[0].clientY:e.clientY,i=t-o;m(Math.max(40,n+i)/r())}function y(){if(!a)return;a=!1,document.body.style.userSelect="";const t=e.getBoundingClientRect().height/r(),n=[o,d,u];let i=n[0],s=Math.abs(t-n[0]);for(let e=1;e<n.length;e++){const a=Math.abs(t-n[e]);a<s&&(s=a,i=n[e])}m(i)}p.addEventListener("mousedown",g),window.addEventListener("mousemove",h),window.addEventListener("mouseup",y),p.addEventListener("touchstart",g,{passive:!0}),window.addEventListener("touchmove",h,{passive:!1}),window.addEventListener("touchend",y),e.addEventListener("touchmove",(t=>{e.classList.contains("sheet-locked")&&t.preventDefault()}),{passive:!1}),window.addEventListener("resize",(()=>{d=l(),u=c();const t=e.getBoundingClientRect().height/r();m(Math.min(t,u))}))}(),function(){let e=null;function t(){try{map.invalidateSize()}catch{}}function n(){try{e&&clearTimeout(e),e=setTimeout(t,200)}catch{}}window.addEventListener("resize",n),window.addEventListener("orientationchange",n),setTimeout(t,400)}();const markers=[];let currentHighlightedMarker=null,userGoal=localStorage.getItem("goal")||"",chatMessages=[],currentLat=40.758,currentLng=-73.985;async function initializeDefaultLocation(){if(localStorage.getItem("borough"))try{const e=getDefaultZipForBorough(),[t,n]=await zipToLatLng(e);currentLat=t,currentLng=n}catch(e){console.log("Failed to get coordinates for borough ZIP, using default")}}async function updateLocationFromBorough(){const e=localStorage.getItem("borough");if(e)try{const t=getDefaultZipForBorough(),[n,a]=await zipToLatLng(t);currentLat=n,currentLng=a,map.setView([n,a],map.getZoom()),myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([n,a],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location (ZIP ${t})`),myLocationMarker.openPopup(),queryStores(n,a),console.log(`Updated location to ${e} (ZIP ${t}): ${n}, ${a}`)}catch(e){console.log("Failed to update location from borough:",e)}}function clearMarkers(){markers.forEach((e=>map.removeLayer(e))),markers.length=0}let fullResults=[],currentPage=1,pageSize=50;function renderList(e){const t=document.getElementById("list"),n=document.getElementById("storesSummary"),a=document.getElementById("pageInfo");t.innerHTML="",fullResults=Array.isArray(e)?e:[],!storeSearchTerm.trim()&&Array.isArray(e)&&(originalFullResults=[...e]);const o=document.getElementById("sortBy"),r=o?o.value:"distance";fullResults=fullResults.slice().sort(((e,t)=>{if("health"===r){const n="number"==typeof e.aiScore&&isFinite(e.aiScore)?e.aiScore:-1/0,a="number"==typeof t.aiScore&&isFinite(t.aiScore)?t.aiScore:-1/0;return a!==n?a-n:(e.distance_m||1/0)-(t.distance_m||1/0)}if("price"===r){const n="number"==typeof e.aiEconomyScore&&isFinite(e.aiEconomyScore)?e.aiEconomyScore:-1/0,a="number"==typeof t.aiEconomyScore&&isFinite(t.aiEconomyScore)?t.aiEconomyScore:-1/0;return a!==n?n-a:(e.distance_m||1/0)-(t.distance_m||1/0)}return(e.distance_m||1/0)-(t.distance_m||1/0)}));const i=fullResults.length;if(!Array.isArray(e)||0===e.length){const e=(parseInt(document.getElementById("radius").value,10)/1609).toFixed(1);if(!isWithinNYC(currentLat,currentLng)){const e=document.createElement("div");e.className="warning",e.innerHTML='\n              <div style="display: flex; align-items: center; gap: 8px;">\n                                <img src="media-webp/Warning.webp" alt="Warning" style="width:16px; height:16px; vertical-align:middle;" class="warning-icon"/>\n                <div>\n                  <strong>Not in NYC Area</strong><br/>\n                  <span style="font-size: 14px; font-weight: normal;">This app is designed for NYC residents. No SNAP stores found in your current location.</span>\n                </div>\n              </div>\n            ',t.appendChild(e)}else{const n=document.createElement("div");n.className="muted",n.style.padding="8px 4px",n.textContent=`No stores found within ${e} miles. Try increasing radius or using your location.`,t.appendChild(n)}return n.textContent="0 results",void(a.textContent="0 / 0")}const s=Math.max(1,Math.ceil(i/pageSize));currentPage>s&&(currentPage=s),currentPage<1&&(currentPage=1);const c=fullResults.slice((currentPage-1)*pageSize,(currentPage-1)*pageSize+pageSize),l=localStorage.getItem("max_results")||"200",d="Unlimited"===l?null:parseInt(l,10)||200,u=d&&i===d?`<div class="cap-note">*(${d} max)</div>`:"";n.innerHTML=`${i} result${1===i?"":"s"}${u}`,a.textContent=`${currentPage} / ${s}`,c.forEach((e=>{const n=document.createElement("div");n.className="store",n.dataset.storeId=String(e.id||"");const a="number"==typeof e.aiScore&&isFinite(e.aiScore)?Math.max(1,Math.min(10,Math.round(e.aiScore))):null,o=a?scoreToColor(a):null,r=(e.aiEconomyScore&&priceToColor(e.aiEconomyScore),"string"==typeof e.aiReason&&e.aiReason.trim()?escapeAttr(e.aiReason):"No reason provided");n.innerHTML=`\n            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">\n              <div>\n                <div style="font-weight:600;">${e.name}</div>\n                <div class="muted">${e.address}, ${e.city} ${e.zip}</div>\n                <div class="muted">${e.storeType} · ${formatDistance(e.distance_m)} · ~${formatWalkTime(e.distance_m)}</div>\n              </div>\n              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">\n                <div style="display:flex; gap:6px; align-items:center;">\n                  ${e.aiEconomyScore?`<span class="tag rating price" data-reason="${e.aiEconomyReason||"No price reason provided"}" data-unfilled="${"$".repeat(5-e.aiEconomyScore)}" style="background: ${1===e.aiEconomyScore?"#90EE90":2===e.aiEconomyScore?"#32CD32":3===e.aiEconomyScore?"#FFA500":4===e.aiEconomyScore?"#FF8C00":"#FF4500"};">${"$".repeat(e.aiEconomyScore)}</span>`:""}\n                  ${a?`<span class="tag rating" data-reason="${r}" style="background:${o}">${a}/10</span>`:""}\n                </div>\n                <div style="display:flex; gap:6px; align-items:center;">\n                  <span class="tag ${e.isHealthyStore?"healthy":"snap"}" data-tip="${e.isHealthyStore?"This store accepts SNAP benefits and is known healthy.":"This store accepts SNAP benefits."}">${e.isHealthyStore?'<img src="media-webp/Check.webp" alt="✓" style="width:12px; height:12px; vertical-align:middle; margin-right:4px; display:inline-block; margin-top:-4px;"/>SNAP-Healthy':"SNAP"}</span>\n                </div>\n                <a class="btn" href="https://www.google.com/maps/dir/?api=1&origin=${currentLat},${currentLng}&destination=${e.latitude},${e.longitude}" target="_blank" rel="noopener" style="padding: 4px 12px;">Route</a>\n              </div>\n            </div>\n          `,n.addEventListener("mouseenter",(()=>{try{const t=Math.max(map.getZoom(),16),n=window.matchMedia&&window.matchMedia("(max-width: 900px)").matches;let a=e.latitude,o=e.longitude;if(n)try{const e=map.project([a,o],t),n=.22*(window.innerHeight||0),r=map.unproject([e.x,e.y+n],t);a=r.lat,o=r.lng}catch{}map.flyTo([a,o],t,{duration:.4}),e&&e._marker&&highlightMarker(e._marker)}catch{}})),n.addEventListener("mouseleave",(()=>{try{resetCurrentHighlight()}catch{}})),n.addEventListener("click",(()=>{document.querySelectorAll("#list .store.selected").forEach((e=>e.classList.remove("selected"))),n.classList.add("selected");try{e&&e._marker&&e._marker.openPopup()}catch{}})),t.appendChild(n)}))}function isWithinNYC(e,t){return e>=40.477&&e<=40.917&&t>=-74.259&&t<=-73.7}function getDefaultZipForBorough(){const e=localStorage.getItem("borough");if(!e)return"10452";return{Bronx:"10452",Brooklyn:"11201",Manhattan:"10001",Queens:"11101","Staten Island":"10301"}[e]||"10452"}function getTypeColor(e){return{"grocery store":"#16A34A","convenience store":"#F59E0B","restaurant meals program":"#EF4444","super store":"#3B82F6",other:"#9CA3AF"}[String(e||"").trim().toLowerCase()]||"#9CA3AF"}function getMarkerColorForStore(e){try{const t=localStorage.getItem("legend_mode")||"type";if("health"===t){const t="number"==typeof e.aiScore&&isFinite(e.aiScore)?Math.max(1,Math.min(10,Math.round(e.aiScore))):null;if(t)return scoreToColor(t)}else if("price"===t){const t="number"==typeof e.aiEconomyScore&&isFinite(e.aiEconomyScore)?Math.max(1,Math.min(5,Math.round(e.aiEconomyScore))):null;if(t){return["#90EE90","#32CD32","#FFA500","#FF8C00","#FF4500"][Math.max(0,Math.min(4,t-1))]}}}catch{}return getTypeColor(e.storeType)}function recolorMarkers(){try{if(!Array.isArray(fullResults))return;fullResults.forEach((e=>{const t=e&&e._marker;if(!t)return;const n=getMarkerColorForStore(e);t.__color=n;const a="number"==typeof t.__baseSize?t.__baseSize:"circle"===t.__type?22:24;"circle"===t.__type?t.setIcon(createCircleIcon(n,a)):"diamond"===t.__type&&t.setIcon(createDiamondIcon(n,a))}))}catch{}}function createDiamondIcon(e,t){const n=`<span class="diamond-shape" style="display:inline-block;width:${t}px;height:${t}px;background:${e};border:2px solid ${e};"></span>`;return L.divIcon({className:"",html:n,iconSize:[t,t],iconAnchor:[t/2,t/2]})}function createCircleIcon(e,t){const n=`<span style="display:inline-block;width:${t}px;height:${t}px;background:${e};border:2px solid ${e};border-radius:50%;opacity:0.9;"></span>`;return L.divIcon({className:"",html:n,iconSize:[t,t],iconAnchor:[t/2,t/2]})}function createWebPMarkerIcon(){return L.icon({iconUrl:"media-webp/marker.webp",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34]})}function createDiamondMarker(e,t,n){const a=createDiamondIcon(n,24),o=L.marker([e,t],{icon:a});return o.__type="diamond",o.__baseSize=24,o.__color=n,o}function formatWalkTime(e){if(!Number.isFinite(e))return"";const t=e/1609.344,n=Math.round(t/2.2*60);if(n<1)return"<1 min";if(n<60)return`${n} min`;const a=Math.floor(n/60),o=n%60;return o?`${a} hr ${o} min`:`${a} hr`}function formatDistance(e){if("km"===(localStorage.getItem("units")||"mi")){return`${(e/1e3).toFixed(2)} km`}return`${(e/1609.344).toFixed(2)} mi`}function formatRadiusLabel(e){if("km"===(localStorage.getItem("units")||"mi")){const t=e/1e3,n=Math.round(10*t)/10;return`${n%1==0?n.toFixed(0):n.toFixed(1)} km`}const t=e/1609.344,n=Math.round(10*t)/10;return`${n%1==0?n.toFixed(0):n.toFixed(1)} mi`}function updateRadiusLabels(){try{const e=document.getElementById("radius");if(!e)return;Array.from(e.options).forEach((e=>{const t=parseFloat(e.value||"0");Number.isFinite(t)&&(e.textContent=formatRadiusLabel(t))}))}catch{}}function scoreToColor(e){const t=(Math.max(1,Math.min(10,Number(e)||1))-1)/9;let n,a,o;if(t<.5){const e=t/.5;n=255,a=Math.round(59+145*e),o=Math.round(48+-48*e)}else{const e=(t-.5)/.5;n=Math.round(255+-239*e),a=Math.round(204+-19*e),o=Math.round(0+129*e)}return`rgb(${n}, ${a}, ${o})`}function priceToColor(e){return["#90EE90","#32CD32","#FFA500","#FF8C00","#FF4500"][Math.max(1,Math.min(5,Number(e)||1))-1]}function renderLegend(){const e=document.getElementById("legend");if(!e)return;let t=localStorage.getItem("legend_mode");if("type"!==t&&"health"!==t&&"price"!==t){t="type";try{localStorage.setItem("legend_mode","type")}catch{}}const n="type"===t?"btn btn-primary":"btn",a="health"===t?"btn btn-primary":"btn",o="price"===t?"btn btn-primary":"btn",r=(()=>{try{return"1"===localStorage.getItem("legend_collapsed")}catch{return!1}})();try{e.classList.toggle("collapsed",r)}catch{}const i=!("undefined"==typeof window||!window.matchMedia)&&window.matchMedia("(max-width: 900px)").matches,s=i?"Key":"Map Key";e.innerHTML=`\n          <div class="legend-header">\n            <h4 style="margin:0; font-size:12px; font-weight:700; color:var(--muted); white-space:nowrap;">${s}</h4>\n            <div style="display:flex; align-items:center; gap:6px" id="legendModeControls">\n              <button id="legendType" class="${n}" style="padding:4px 8px; font-size:12px">Type</button>\n              <button id="legendHealth" class="${a}" style="padding:4px 8px; font-size:12px">Health</button>\n              <button id="legendPrice" class="${o}" style="padding:4px 8px; font-size:12px">${i?"$":"Price"}</button>\n            </div>\n            <button id="legendToggle" class="legend-toggle" title="Toggle map key" aria-label="Toggle map key" style="margin-left:0px;"></button>\n          </div>\n          <div id="legendBody"></div>\n        `;const c=e.querySelector("#legendBody");if(!c)return;c.innerHTML="health"===t?`\n            <div class="legend-section">\n              <div class="legend-item"><span class="swatch" style="background:${scoreToColor(9)}"></span> 9–10 (Excellent)</div>\n              <div class="legend-item"><span class="swatch" style="background:${scoreToColor(7)}"></span> 7–8 (Good)</div>\n              <div class="legend-item"><span class="swatch" style="background:${scoreToColor(5)}"></span> 5–6 (Fair)</div>\n              <div class="legend-item"><span class="swatch" style="background:${scoreToColor(3)}"></span> 3–4 (Limited)</div>\n              <div class="legend-item"><span class="swatch" style="background:${scoreToColor(1)}"></span> 1–2 (Poor)</div>\n            </div>\n            <div class="legend-section">\n              <div class="legend-item"><span class="shape circle"></span> Not Known Healthy</div>\n              <div class="legend-item"><span class="shape diamond"></span> Known Healthy</div>\n              <div class="legend-item"><img alt="my loc" style="width:14px; height:22px" src="media-webp/marker.webp"/> My location</div>\n            </div>\n          `:"price"===t?'\n            <div class="legend-section">\n              <div class="legend-item"><span class="swatch" style="background:#90EE90"></span> 1/5 (Very Affordable)</div>\n              <div class="legend-item"><span class="swatch" style="background:#32CD32"></span> 2/5 (Affordable)</div>\n              <div class="legend-item"><span class="swatch" style="background:#FFA500"></span> 3/5 (Moderate)</div>\n              <div class="legend-item"><span class="swatch" style="background:#FF8C00"></span> 4/5 (Expensive)</div>\n              <div class="legend-item"><span class="swatch" style="background:#FF4500"></span> 5/5 (Very Expensive)</div>\n            </div>\n            <div class="legend-section">\n              <div class="legend-item"><span class="shape circle"></span> Not Known Healthy</div>\n              <div class="legend-item"><span class="shape diamond"></span> Known Healthy</div>\n              <div class="legend-item"><img alt="my loc" style="width:14px; height:22px" src="media-webp/marker.webp"/> My location</div>\n            </div>\n          ':'\n            <div class="legend-section">\n              <div class="legend-item"><span class="swatch" style="background:#16A34A"></span> Grocery Store</div>\n              <div class="legend-item"><span class="swatch" style="background:#F59E0B"></span> Convenience Store</div>\n              <div class="legend-item"><span class="swatch" style="background:#EF4444"></span> Restaurant Meals Program</div>\n              <div class="legend-item"><span class="swatch" style="background:#3B82F6"></span> Super Store</div>\n              <div class="legend-item"><span class="swatch" style="background:#9CA3AF"></span> Other</div>\n            </div>\n            <div class="legend-section">\n              <div class="legend-item"><span class="shape circle"></span> Not Known Healthy</div>\n              <div class="legend-item"><span class="shape diamond"></span> Known Healthy</div>\n              <div class="legend-item"><img alt="my loc" style="width:14px; height:22px" src="media-webp/marker.webp"/> My location</div>\n            </div>\n          ';const l=e.querySelector("#legendType"),d=e.querySelector("#legendHealth"),u=e.querySelector("#legendPrice"),m=e.querySelector("#legendToggle");l&&l.addEventListener("click",(()=>{localStorage.setItem("legend_mode","type"),renderLegend(),recolorMarkers()})),d&&d.addEventListener("click",(()=>{localStorage.setItem("legend_mode","health"),renderLegend(),recolorMarkers()})),u&&u.addEventListener("click",(()=>{localStorage.setItem("legend_mode","price"),renderLegend(),recolorMarkers()})),m&&m.addEventListener("click",(()=>{try{const t=e.classList.toggle("collapsed");localStorage.setItem("legend_collapsed",t?"1":"0"),renderLegend()}catch{}}))}function escapeAttr(e){return String(null==e?"":e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\r\n]+/g," ")}function getMagnifyIcon(){return document.body.classList.contains("dark")?"media-webp/Magnifying Glass Dark.webp":"media-webp/Magnifying Glass Light.webp"}function buildPopupHtml(e){const t=e.isHealthyStore?`<img src="media-webp/Check.webp" class="known-healthy" data-tip="Known Healthy Store" alt="Healthy" style="width:14px; height:14px; vertical-align:middle; margin-right:4px"/><strong>${e.name}</strong>`:`<strong>${e.name}</strong>`,n=formatWalkTime(e.distance_m),a="number"==typeof e.aiScore&&isFinite(e.aiScore)?Math.max(1,Math.min(10,Math.round(e.aiScore))):null,o=a?scoreToColor(a):null,r="string"==typeof e.aiReason&&e.aiReason.trim()?escapeAttr(e.aiReason):"No reason provided",i="number"==typeof e.aiEconomyScore&&isFinite(e.aiEconomyScore)?Math.max(1,Math.min(5,Math.round(e.aiEconomyScore))):null,s="string"==typeof e.aiEconomyReason&&e.aiEconomyReason.trim()?escapeAttr(e.aiEconomyReason):"No price reason provided";return`${t} <button class="icon-btn" data-ask="${encodeURIComponent(e.name)}" title="Ask coach about this place"><img data-magnify="1" src="${getMagnifyIcon()}" alt="Ask" style="width:12px; height:12px; vertical-align:middle"/></button><br/>${e.address}<br/>${e.city} ${e.zip}<br/><strong>Store type:</strong> ${e.storeType||"N/A"}<br/><strong>Distance: </strong>${formatDistance(e.distance_m)}${n?` · ~${n}`:""}${a||i?`<br/><div style="display:flex; gap:4px; margin:4px 0;">${i?`<span class="tag rating price" data-reason="${s}" data-unfilled="${"$".repeat(5-i)}" style="background: ${1===i?"#90EE90":2===i?"#32CD32":3===i?"#FFA500":4===i?"#FF8C00":"#FF4500"};">${"$".repeat(i)}</span>`:""}${a?`<span class="tag rating" style="background:${o}" data-reason="${r}">${a}/10</span>`:""}</div>`:""}`}function addMarkers(e){clearMarkers(),currentHighlightedMarker=null,e.forEach((e=>{const t=getMarkerColorForStore(e),n=(e.isHealthyStore?e.name:e.name,formatWalkTime(e.distance_m),"number"==typeof e.aiScore&&isFinite(e.aiScore)?Math.max(1,Math.min(10,Math.round(e.aiScore))):null),a=(n&&scoreToColor(n),"string"==typeof e.aiReason&&e.aiReason.trim()&&escapeAttr(e.aiReason),buildPopupHtml(e));let o;if(e.isHealthyStore)o=createDiamondMarker(e.latitude,e.longitude,t);else{const n=22,a=createCircleIcon(t,n);o=L.marker([e.latitude,e.longitude],{icon:a}),o.__type="circle",o.__baseSize=n,o.__color=t}o.addTo(map).bindPopup(a),o.on("click",(()=>{try{const t=document.querySelector('.tabs button[data-tab="stores"]');t&&t.click();const n=String(e.id||""),a=Array.isArray(fullResults)?fullResults.findIndex((e=>String(e&&e.id||"")===n)):-1;a>=0&&(currentPage=Math.floor(a/pageSize)+1,renderList(fullResults)),setTimeout((()=>{const e=document.getElementById("list");if(!e)return;const t=e.querySelector(`[data-store-id="${n}"]`),a=document.querySelector(".panel.sheet-locked");t&&"function"==typeof t.scrollIntoView&&!a&&(t.scrollIntoView({behavior:"smooth",block:"center"}),document.querySelectorAll("#list .store.selected").forEach((e=>e.classList.remove("selected"))),t.classList.add("selected"))}),0)}catch{}})),o.on("popupopen",(()=>{const t=o.getPopup().getElement();if(!t)return;try{const e=t.querySelector("img[data-magnify]");e&&(e.src=getMagnifyIcon())}catch{}try{const t=String(e.id||"");document.querySelectorAll("#list .store.selected").forEach((e=>e.classList.remove("selected")));const n=document.getElementById("list");if(n){const e=n.querySelector(`[data-store-id="${t}"]`);e&&e.classList.add("selected")}}catch{}const n=t.querySelector("button[data-ask]");n&&n.addEventListener("click",(e=>{e.preventDefault();const t=document.querySelector('.tabs button[data-tab="coach"]');t&&t.click();const a=`What food options might I find at ${decodeURIComponent(n.getAttribute("data-ask")||"this location")}?`;document.getElementById("chatInput").value=a,document.getElementById("chatSend").click()}),{once:!0})})),o.on("popupclose",(()=>{try{const t=String(e.id||""),n=document.getElementById("list");if(!n)return;const a=n.querySelector(`[data-store-id="${t}"]`);a&&a.classList.remove("selected")}catch{}}));try{e._marker=o}catch{}markers.push(o)}))}function resetCurrentHighlight(){if(!currentHighlightedMarker)return;const e=currentHighlightedMarker;try{if("circle"===e.__type&&"number"==typeof e.__baseSize){const t=e.__color||"#5AC68A";e.setIcon(createCircleIcon(t,e.__baseSize))}else if("diamond"===e.__type&&"number"==typeof e.__baseSize){const t=e.__color||"#5AC68A";e.setIcon(createDiamondIcon(t,e.__baseSize))}}catch{}currentHighlightedMarker=null}function highlightMarker(e){if(e&&currentHighlightedMarker!==e){resetCurrentHighlight();try{if(HIGHLIGHT_SIZE_INCREASE=25,"circle"===e.__type){const t="number"==typeof e.__baseSize?e.__baseSize:22,n=e.__color||"#5AC68A";e.setIcon(createCircleIcon(n,t+HIGHLIGHT_SIZE_INCREASE))}else if("diamond"===e.__type){const t="number"==typeof e.__baseSize?e.__baseSize:24,n=e.__color||"#5AC68A";e.setIcon(createDiamondIcon(n,t+HIGHLIGHT_SIZE_INCREASE))}currentHighlightedMarker=e}catch{}}}async function queryStores(e,t){currentLat=e,currentLng=t;const n=document.getElementById("radius").value,a=document.getElementById("healthy").value,o=localStorage.getItem("max_results")||"200",r=`/stores?lat=${e}&lng=${t}&radius=${n}&isHealthy=${a}&limit=${"Unlimited"===o?1e6:parseInt(o,10)||200}`;try{const e=await fetch(API_BASE+r);if(!e.ok)throw new Error("fetch failed");const t=await e.json();return addMarkers(t),renderList(t),t.length&&map.setView([t[0].latitude,t[0].longitude],map.getZoom()),t}catch{return renderList([]),[]}}async function queryWithFallback(e,t){const n=document.getElementById("radius"),a=n.value;currentPage=1;let o=await queryStores(e,t);if(o.length)return;const r=["1609","3219","8046"];for(const i of r)if(i!==a&&(n.value=i,o=await queryStores(e,t),o.length))return;n.value=a}async function zipToLatLng(e){try{const t=await fetch(`${API_BASE}/zip/${encodeURIComponent(e)}`);if(!t.ok)throw new Error("zip not found");const n=await t.json();return[n.latitude,n.longitude]}catch{throw new Error("Invalid ZIP code. Please enter a valid NYC area ZIP code.")}}let myLocationMarker=null;function isGeolocationSupported(){return"geolocation"in navigator}function showLocationHelp(){let e="To use your location:\n\n";window.innerWidth<=900?(e+="1. Make sure location services are enabled on your device\n",e+="2. Allow location access when prompted by your browser\n",e+="3. If using Safari on iOS, go to Settings > Safari > Location and allow\n",e+="4. If using Chrome on Android, check app permissions in Settings\n\n"):(e+="1. Allow location access when prompted by your browser\n",e+="2. Check that location services are enabled in your system settings\n\n"),e+="Alternatively, you can enter a ZIP code to search for stores in that area.",alert(e)}document.getElementById("locBtn").addEventListener("click",(()=>{clearStoreContext();const e=document.getElementById("storeSearch");if(e&&(e.value="",storeSearchTerm="",filteredStoreResults=[],originalFullResults.length>0&&(renderList(originalFullResults),addMarkers(originalFullResults))),!isGeolocationSupported())return void alert("Geolocation is not supported in your browser. Please enter a ZIP code instead.");navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:n}=e.coords;map.setView([t,n],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker);const a=(document.getElementById("zip")?.value||"").trim(),o=a?` (ZIP ${a})`:"";myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location${o}`),myLocationMarker.openPopup(),queryStores(t,n)}),(e=>{let t="Location access failed. ";switch(e.code){case e.PERMISSION_DENIED:t+="Please enable location access in your browser settings or enter a ZIP code.",showLocationHelp();break;case e.POSITION_UNAVAILABLE:t+="Location information is unavailable. Please enter a ZIP code.";break;case e.TIMEOUT:t+="Location request timed out. Please try again or enter a ZIP code.";break;default:t+="Please enter a ZIP code instead."}alert(t)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})),document.getElementById("searchBtn").addEventListener("click",(async()=>{clearStoreContext();const e=document.getElementById("storeSearch");e&&(e.value="",storeSearchTerm="",filteredStoreResults=[],originalFullResults.length>0&&(renderList(originalFullResults),addMarkers(originalFullResults)));const t=document.getElementById("zip").value.trim();try{const[e,n]=await zipToLatLng(t);currentLat=e,currentLng=n,map.setView([e,n],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker);const a=t?` (ZIP ${t})`:"";myLocationMarker=L.marker([e,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location${a}`),myLocationMarker.openPopup(),queryWithFallback(e,n)}catch(e){return void alert(e.message)}})),(async()=>{try{const e=document.getElementById("zip");e&&(e.value="");const t=getDefaultZipForBorough();if(t){e.value=t;const[n,a]=await zipToLatLng(t);currentLat=n,currentLng=a,map.setView([n,a],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([n,a],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location (ZIP ${t})`),myLocationMarker.openPopup(),queryWithFallback(n,a)}navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:n}=e.coords;currentLat=t,currentLng=n,map.setView([t,n],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup("My location"),myLocationMarker.openPopup(),queryStores(t,n);try{updateRadiusLabels()}catch{}}),(async e=>{try{const e=getDefaultZipForBorough(),[t,n]=await zipToLatLng(e);currentLat=t,currentLng=n,map.setView([t,n],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location (ZIP ${e})`),myLocationMarker.openPopup(),queryWithFallback(t,n);try{updateRadiusLabels()}catch{}}catch{try{const e=getDefaultZipForBorough(),[t,n]=await zipToLatLng(e);myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location (ZIP ${e})`),myLocationMarker.openPopup(),queryWithFallback(t,n)}catch{myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([40.758,-73.985],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup("My location (Default)"),myLocationMarker.openPopup(),queryWithFallback(40.758,-73.985)}}}))}catch{try{const e=getDefaultZipForBorough(),[t,n]=await zipToLatLng(e);myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup(`My location (ZIP ${e})`),myLocationMarker.openPopup(),queryWithFallback(t,n)}catch{myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([40.758,-73.985],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup("My location (Default)"),myLocationMarker.openPopup(),queryWithFallback(40.758,-73.985)}}})();const tipEl=document.createElement("div");tipEl.className="hover-tip",document.body.appendChild(tipEl);let tipVisible=!1;function showTip(e,t){tipEl.textContent=e||"",tipEl.style.display="block";const n=t.getBoundingClientRect(),a=Math.min(260,tipEl.offsetWidth||0)||0,o=n.left+n.width/2-a/2,r=Math.max(8,Math.min(window.innerWidth-8-a,o));tipEl.style.left=r+"px",tipEl.style.top=n.bottom+8+"px",tipVisible=!0}function hideTip(){tipVisible&&(tipEl.style.display="none",tipVisible=!1)}function getUserLocationAndUpdateMarker(){if(!isGeolocationSupported())return void updateLocationFromBorough();navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:n}=e.coords;currentLat=t,currentLng=n,map.setView([t,n],DEFAULT_ZOOM),myLocationMarker&&map.removeLayer(myLocationMarker),myLocationMarker=L.marker([t,n],{icon:createWebPMarkerIcon()}).addTo(map).bindPopup("My location"),myLocationMarker.openPopup(),queryStores(t,n)}),(e=>{updateLocationFromBorough()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}function renderOnboarding(){if(localStorage.getItem("onboarded"))return;const e=document.createElement("div");e.className="onboard",e.style.opacity="0",e.innerHTML='\n          <div class="bg-fruit" aria-hidden="true"></div>\n          <div class="title-hero">SNAPwise NYC</div>\n          <div class="card">\n            <div class="logo-wrap"><img src="media-webp/icons/IconCover180x180.webp" alt="App icon" onerror="this.onerror=null; this.src=\'media-webp/icons/InWebsiteIcon.webp\';"></div>\n            <h2>Welcome! What brings you here?</h2>\n            <p>Select a goal to personalize your experience.</p>\n            <div class="goals">\n              <div class="goal" data-goal="lose_weight">Lose weight</div>\n              <div class="goal" data-goal="cheap_food">Spend less on food</div>\n              <div class="goal" data-goal="explore">Explore options</div>\n            </div>\n            <div class="field">\n              <label>Are you currently on SNAP Food Stamps?</label>\n              <div class="radio-group">\n                <label><input type="radio" name="snapStatus" value="yes"> Yes, I am</label>\n                <label><input type="radio" name="snapStatus" value="no"> No, I am not</label>\n              </div>\n            </div>\n            <div class="field">\n              <label>Which borough of NYC do you live in?</label>\n              <select id="boroughSelect">\n                <option value="">Select borough…</option>\n                <option value="Bronx">Bronx</option>\n                <option value="Brooklyn">Brooklyn</option>\n                <option value="Manhattan">Manhattan</option>\n                <option value="Queens">Queens</option>\n                <option value="Staten Island">Staten Island</option>\n              </select>\n            </div>\n            <div class="actions">\n              <button id="skipOnboard" class="btn btn-ghost">Skip</button>\n              <button id="continueOnboard" class="btn btn-primary" disabled>Continue</button>\n            </div>\n          </div>\n          <div style="font-size:10px; font-style:italic; color:var(--muted); text-align:center; margin:8px 0 0 0;">Maximilian Ising</div>',document.body.appendChild(e);try{requestAnimationFrame((()=>{e.style.opacity="1",setTimeout((()=>{try{e.style.removeProperty("opacity")}catch{}}),600)}))}catch{setTimeout((()=>{try{e.style.opacity="1"}catch{}setTimeout((()=>{try{e.style.removeProperty("opacity")}catch{}}),600)}),0)}let t=null;try{const t=["media-webp/fruit/Apple.webp","media-webp/fruit/Avocado.webp","media-webp/fruit/Banana.webp","media-webp/fruit/Blue Berries.webp","media-webp/fruit/Carrot.webp","media-webp/fruit/Cherry.webp","media-webp/fruit/Coconut.webp","media-webp/fruit/Corn.webp","media-webp/fruit/Cranberries.webp","media-webp/fruit/Eggplant.webp","media-webp/fruit/Grapes.webp","media-webp/fruit/Lettuce.webp","media-webp/fruit/Mango.webp","media-webp/fruit/Onion.webp","media-webp/fruit/Pear.webp","media-webp/fruit/Pepper.webp","media-webp/fruit/Strawberries.webp","media-webp/fruit/Tomato.webp","media-webp/fruit/Watermelon.webp"],n=e.querySelector(".bg-fruit"),a=80,o=window.innerWidth/(96*window.devicePixelRatio),r=Math.floor(1600/o),i=r+200;!function e(){!function(){if(!n)return!1;if(n.children.length>=a)return!1;const e=document.createElement("img");e.className="fruit",e.src=t[Math.floor(Math.random()*t.length)];const o=50+50*Math.random();let r=100*Math.random();const i=6+6*Math.random();e.style.width=`${o}px`,e.style.height="auto",e.style.left=`${r}vw`,e.style.animation=`fruitFall ${i}s linear 0s 1 both`,e.addEventListener("animationiteration",(()=>{r=Math.max(0,Math.min(100,r+(20*Math.random()-10))),e.style.left=`${r}vw`})),e.addEventListener("animationend",(()=>{try{e.remove()}catch{}})),n.appendChild(e)}();const o=r+Math.random()*(i-r);setTimeout(e,o)}()}catch{}function n(){const n=!!t,a=!!e.querySelector('input[name="snapStatus"]:checked'),o=!!(e.querySelector("#boroughSelect")?.value||"").trim();e.querySelector("#continueOnboard").disabled=!(n&&a&&o)}e.querySelectorAll(".goal").forEach((a=>{a.addEventListener("click",(()=>{e.querySelectorAll(".goal").forEach((e=>e.classList.remove("selected"))),a.classList.add("selected"),t=a.dataset.goal,n()}))})),e.querySelectorAll('input[name="snapStatus"]').forEach((e=>e.addEventListener("change",n))),e.querySelector("#boroughSelect").addEventListener("change",(e=>{n();e.target.value.trim()&&updateLocationFromBorough()})),e.querySelector("#skipOnboard").addEventListener("click",(()=>{localStorage.setItem("onboarded","1");try{e.style.removeProperty("opacity")}catch{}e.classList.add("fade-out"),setTimeout((()=>{try{document.body.removeChild(e)}catch{}}),800),getUserLocationAndUpdateMarker()})),e.querySelector("#continueOnboard").addEventListener("click",(()=>{userGoal=t||"explore";const n=e.querySelector('input[name="snapStatus"]:checked'),a=n?n.value:void 0,o=(e.querySelector("#boroughSelect")?.value||"").trim()||void 0;localStorage.setItem("goal",userGoal),localStorage.setItem("onboarded","1"),a&&localStorage.setItem("snap_status",a),o&&localStorage.setItem("borough",o);try{e.style.removeProperty("opacity")}catch{}e.classList.add("fade-out"),setTimeout((()=>{try{document.body.removeChild(e)}catch{}}),800),appendChat("assistant",`Got it! If your goal is ${userGoal.replace("_"," ")}, focus on protein, fiber, and low-cost basics. Ask me for a 5-minute meal idea!`),getUserLocationAndUpdateMarker()}))}function appendChat(e,t){const n=document.getElementById("chatLog"),a=document.createElement("div");if(a.className=`msg ${e}`,"assistant"===e){const e=DOMPurify.sanitize(marked.parse(String(t||"")));a.innerHTML=e,makeStoreNamesClickable(a)}else a.textContent=t;return n.appendChild(a),n.scrollTop=n.scrollHeight,a}function makeStoreNamesClickable(e){let t=e.innerHTML,n=!1;const a=void 0!==originalFullResults&&Array.isArray(originalFullResults)&&originalFullResults.length>0;let o=[];function r(e){const t=document.createElement("textarea");return t.innerHTML=e,t.value}a&&(o=[...originalFullResults].sort(((e,t)=>{const n=(e.distance_m||1/0)-(t.distance_m||1/0);return 0!==n?n:t.name.length-e.name.length})));const i=/%l([^%]+)%l|\*\*([^*]+)\*\*/g;let s,c=!1;for(;null!==(s=i.exec(t));){const e=(s[1]||s[2]).trim(),n=r(e);let i=null;if(a&&(i=o.find((e=>{const t=e.name.toLowerCase().trim(),a=n.toLowerCase().trim();if(t===a)return!0;if(t.includes(a)||a.includes(t))return!0;const o=t.split(/\s+/).filter((e=>e.length>0));return a.split(/\s+/).filter((e=>e.length>0)).every((e=>o.some((t=>t.includes(e)||e.includes(t)))))}))),i){const n=`<span class="store-link" style="color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 500;" title="Click to view ${i.name} on map" data-store-id="${i.id}">${e}</span>`;t=t.replace(s[0],n),c=!0}else t=t.replace(s[0],e)}c&&(n=!0);let l=t.match(/%l[^%]*%l/g);l&&(l.forEach((e=>{const n=e.replace(/%l/g,"");t=t.replace(e,n)})),n=!0);const d=t.match(/%l(?!.*%l)/g);if(d&&(d.forEach((e=>{const n=e.replace(/%l/g,"");t=t.replace(e,n)})),n=!0),t.includes("%l")&&(t=t.replace(/%l/g,""),n=!0),n&&(e.innerHTML=t,a)){e.querySelectorAll(".store-link").forEach((e=>{const t=e.getAttribute("data-store-id"),n=originalFullResults.find((e=>e.id===t));n&&e.addEventListener("click",(()=>{highlightStoreOnMap(n)}))}))}}function highlightStoreOnMap(e){try{if(e._marker){const t=Math.max(map.getZoom(),16),n=window.matchMedia&&window.matchMedia("(max-width: 900px)").matches;let a=e.latitude,o=e.longitude;if(n)try{const e=map.project([a,o],t),n=.22*(window.innerHeight||0),r=map.unproject([e.x,e.y+n],t);a=r.lat,o=r.lng}catch{}map.flyTo([a,o],t,{duration:.4}),highlightMarker(e._marker),e._marker.openPopup();const r=document.querySelector(`[data-store-id="${e.id}"]`);r&&(document.querySelectorAll("#list .store.selected").forEach((e=>e.classList.remove("selected"))),r.classList.add("selected"),r.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Error highlighting store on map:",e)}}function clearStoreContext(){void 0!==originalFullResults&&(originalFullResults=[]),void 0!==filteredStoreResults&&(filteredStoreResults=[])}function createThinkingMessage(){const e=document.getElementById("chatLog"),t=document.createElement("div");t.className="msg assistant";const n=document.createElement("span");return n.className="thinking",n.textContent=".",t.appendChild(n),e.appendChild(t),e.scrollTop=e.scrollHeight,{container:t,dotsEl:n}}function startThinkingAnimation(e){if(!e)return;try{e._thinkingTimer&&clearInterval(e._thinkingTimer)}catch{}const t=["Thinking.","Thinking..","Thinking..."];let n=0;e.textContent=t[n],e._thinkingTimer=setInterval((()=>{n=(n+1)%t.length,e.textContent=t[n]}),400)}function stopThinkingAnimation(e){try{e&&e._thinkingTimer&&(clearInterval(e._thinkingTimer),e._thinkingTimer=null)}catch{}}async function sendChat(e){chatMessages.push({role:"user",content:e}),appendChat("user",e);const t=createThinkingMessage();startThinkingAnimation(t.dotsEl);const n=localStorage.getItem("resp_len")||"default";let a=[];if(void 0!==originalFullResults&&Array.isArray(originalFullResults)&&originalFullResults.length>0){a=[...originalFullResults].sort(((e,t)=>(e.distance_m||1/0)-(t.distance_m||1/0))).slice(0,100).map((e=>({name:e.name,address:e.address,city:e.city,zip:e.zip,storeType:e.storeType,distance:e.distance_m,isHealthyStore:e.isHealthyStore,aiScore:e.aiScore,aiReason:e.aiReason})))}const o={goal:userGoal,responseLength:n,messages:chatMessages.slice(-10),context:{zip:document.getElementById("zip").value,stores:a}},r=await fetch(`${API_BASE}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!r.ok)return stopThinkingAnimation(t.dotsEl),void(t.container.textContent="Sorry, the coach is busy. Try again later.");const i=await r.json(),s=i.choices?.[0]?.message?.content||"Okay.";chatMessages.push({role:"assistant",content:s}),stopThinkingAnimation(t.dotsEl),t.container.remove(),appendChat("assistant",s)}function loadTracker(){const e=localStorage.getItem("tracker")||"{}";try{return JSON.parse(e)}catch{return{}}}function saveTracker(e){localStorage.setItem("tracker",JSON.stringify(e))}function todayKey(){const e=new Date;return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}function renderTracker(){const e=loadTracker(),t=e[todayKey()]||{meals:[],totals:{cal:0,protein:0}};document.getElementById("calTarget").value=e.calTarget||"",document.getElementById("proteinTarget").value=e.proteinTarget||"",document.getElementById("mealList").innerHTML=t.meals.map((e=>`<div class="muted">${e.name}: ${e.cal} cal, ${e.protein}g</div>`)).join("");const n=parseInt(e.calTarget||"0",10),a=parseInt(e.proteinTarget||"0",10);document.getElementById("todayTotals").textContent=`Calories: ${t.totals.cal}${n?` / ${n}`:""} · Protein: ${t.totals.protein}g${a?` / ${a}g`:""}`}function addMeal(e,t,n){if(!e||!Number.isFinite(t)||!Number.isFinite(n))return;const a=loadTracker(),o=todayKey();a[o]||(a[o]={meals:[],totals:{cal:0,protein:0}}),a[o].meals.push({name:e,cal:t,protein:n}),a[o].totals.cal+=t,a[o].totals.protein+=n,saveTracker(a),renderTracker()}document.addEventListener("mouseover",(e=>{const t=e.target;if(t&&t.classList)if(t.classList.contains("rating")){const e=t.getAttribute("data-reason")||"";e&&showTip(e,t)}else if(t.classList.contains("known-healthy")){showTip(t.getAttribute("data-tip")||"Known Healthy Store",t)}else if(t.classList.contains("snap")||t.classList.contains("healthy")){const e=t.getAttribute("data-tip")||"";e&&showTip(e,t)}})),document.addEventListener("mouseout",(e=>{const t=e.relatedTarget,n=e.target;n&&n.classList&&(n.classList.contains("rating")?t&&t.classList&&t.classList.contains("rating")||hideTip():n.classList.contains("known-healthy")?t&&t.classList&&t.classList.contains("known-healthy")||hideTip():(n.classList.contains("snap")||n.classList.contains("healthy"))&&(t&&t.classList&&(t.classList.contains("snap")||t.classList.contains("healthy"))||hideTip()))})),document.getElementById("radius").addEventListener("change",(()=>{const e=document.getElementById("storeSearch");e&&(e.value="",storeSearchTerm="",filteredStoreResults=[],originalFullResults.length>0&&(renderList(originalFullResults),addMarkers(originalFullResults))),queryStores(currentLat,currentLng)})),document.getElementById("healthy").addEventListener("change",(()=>{const e=document.getElementById("storeSearch");e&&(e.value="",storeSearchTerm="",filteredStoreResults=[],originalFullResults.length>0&&(renderList(originalFullResults),addMarkers(originalFullResults))),queryStores(currentLat,currentLng)})),document.getElementById("sortBy").addEventListener("change",(()=>{renderList(fullResults)})),document.querySelectorAll(".tabs button").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".tabs button").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".tab").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.getElementById("tab-"+e.dataset.tab).classList.add("active")}))})),document.getElementById("prevPage").addEventListener("click",(()=>{currentPage>1&&(currentPage-=1,renderList(fullResults))})),document.getElementById("nextPage").addEventListener("click",(()=>{const e=Math.max(1,Math.ceil(fullResults.length/pageSize));currentPage<e&&(currentPage+=1,renderList(fullResults))})),document.getElementById("pageSize").addEventListener("change",(e=>{pageSize=parseInt(e.target.value,10)||50,currentPage=1,renderList(fullResults)})),renderOnboarding(),function(){const e=document.getElementById("returnHome");e&&e.addEventListener("click",(e=>{e.preventDefault();try{localStorage.removeItem("onboarded"),localStorage.removeItem("goal"),localStorage.removeItem("snap_status"),localStorage.removeItem("borough")}catch{}renderOnboarding();const t=document.getElementById("settings");t&&(t.open=!1),window.scrollTo({top:0,behavior:"smooth"}),currentLat=40.758,currentLng=-73.985,map.setView([currentLat,currentLng],map.getZoom())}))}(),function(){const e=document.getElementById("settings");if(!e)return;const t=e.querySelector("summary");function n(){try{e.open||(e.open=!0)}catch{}}n(),t&&t.addEventListener("click",(t=>{t.preventDefault(),n(),e.classList.toggle("is-open")})),document.addEventListener("click",(t=>{try{const a=t.target;if(!a)return;if(e.contains(a))return;e.classList.remove("is-open"),n()}catch{}})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&(e.classList.remove("is-open"),n())}))}(),function(){const e=document.getElementById("toggleDark");if("dark"===(localStorage.getItem("theme")||"light")){document.body.classList.add("dark"),e&&(e.checked=!0);const t=document.getElementById("reviewDietIcon");t&&(t.src="media-webp/Magnifying Glass Dark.webp")}try{updateMapTheme()}catch{}e&&e.addEventListener("change",(()=>{const t=e.checked;document.body.classList.toggle("dark",t),localStorage.setItem("theme",t?"dark":"light");const n=document.getElementById("reviewDietIcon");n&&(n.src=t?"media-webp/Magnifying Glass Dark.webp":"media-webp/Magnifying Glass Light.webp");try{document.querySelectorAll(".leaflet-popup-content img[data-magnify]").forEach((e=>{e.src=getMagnifyIcon()}))}catch{}try{updateMapTheme()}catch{}}))}(),function(){const e=document.getElementById("unitSystem");if(!e)return;const t=localStorage.getItem("units")||"mi";e.value="km"===t?"km":"mi";try{updateRadiusLabels()}catch{}e.addEventListener("change",(()=>{const t="km"===e.value?"km":"mi";localStorage.setItem("units",t);try{renderList(fullResults),updateRadiusLabels()}catch{}}))}(),function(){const e=document.getElementById("respLenGroup");if(!e)return;const t=localStorage.getItem("resp_len")||"default";function n(t){e.querySelectorAll("button").forEach((e=>{const n=e.getAttribute("data-val")===t;e.classList.toggle("btn-primary",n)}))}n(["concise","default","comprehensive"].includes(t)?t:"default"),e.querySelectorAll("button").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-val")||"default",a=["concise","default","comprehensive"].includes(t)?t:"default";localStorage.setItem("resp_len",a),n(a)}))}))}(),function(){const e=document.getElementById("maxResults");if(!e)return;const t=localStorage.getItem("max_results")||"200";e.value=["100","200","500","Unlimited"].includes(t)?t:"200",e.addEventListener("change",(()=>{const t=e.value,n=["100","200","500","Unlimited"].includes(t)?t:"200";localStorage.setItem("max_results",n);try{queryStores(currentLat,currentLng)}catch{}}))}(),document.getElementById("chatClear").addEventListener("click",(()=>{chatMessages=[];document.getElementById("chatLog").innerHTML=""})),document.getElementById("chatSend").addEventListener("click",(()=>{const e=document.getElementById("chatInput"),t=e.value.trim();t&&(e.value="",sendChat(t))})),document.getElementById("chatInput").addEventListener("keydown",(e=>{"Enter"===e.key&&document.getElementById("chatSend").click()})),function(){const e=document.getElementById("zip");e&&(e.addEventListener("keydown",(e=>{if("Enter"===e.key){e.preventDefault();const t=document.getElementById("searchBtn");t&&t.click()}})),e.addEventListener("input",(()=>{clearStoreContext()})))}(),document.getElementById("addMeal").addEventListener("click",(()=>{addMeal(document.getElementById("mealName").value.trim(),parseInt(document.getElementById("mealCals").value||"0",10),parseInt(document.getElementById("mealProtein").value||"0",10)),document.getElementById("mealName").value="",document.getElementById("mealCals").value="",document.getElementById("mealProtein").value=""})),document.getElementById("resetLog").addEventListener("click",(()=>{if(!confirm("Clear today's meals? This cannot be undone."))return;const e=loadTracker(),t=todayKey();e[t]&&(e[t]={meals:[],totals:{cal:0,protein:0}},saveTracker(e),renderTracker())})),document.getElementById("reviewDiet").addEventListener("click",(()=>{const e=loadTracker(),t=e[todayKey()]||{meals:[],totals:{cal:0,protein:0}},n={totals:t.totals,meals:t.meals,targets:{cal:parseInt(e.calTarget||"0",10)||0,protein:parseInt(e.proteinTarget||"0",10)||0}},a=document.querySelector('.tabs button[data-tab="coach"]');a&&a.click();const o=`Please review today's diet in depth. What's missing and what's in excess? Consider targets if set. Here's JSON: ${JSON.stringify(n)}`;document.getElementById("chatInput").value=o,document.getElementById("chatSend").click()})),document.getElementById("calTarget").addEventListener("change",(e=>{const t=loadTracker();t.calTarget=parseInt(e.target.value||"0",10)||void 0,saveTracker(t),renderTracker()})),document.getElementById("proteinTarget").addEventListener("change",(e=>{const t=loadTracker();t.proteinTarget=parseInt(e.target.value||"0",10)||void 0,saveTracker(t),renderTracker()})),renderTracker();let storeSearchTerm="",filteredStoreResults=[],originalFullResults=[];function filterStoresBySearch(e){if(!e.trim())return void(filteredStoreResults=[...originalFullResults]);const t=e.toLowerCase().trim();filteredStoreResults=originalFullResults.filter((e=>e.name.toLowerCase().includes(t)||e.address.toLowerCase().includes(t)||e.city.toLowerCase().includes(t)||e.storeType.toLowerCase().includes(t)||e.zip.toLowerCase().includes(t)))}function updateStoreListWithSearch(){storeSearchTerm.trim()?(renderList(filteredStoreResults),addMarkers(filteredStoreResults)):(renderList(originalFullResults),addMarkers(originalFullResults))}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("storeSearch");e&&(e.addEventListener("input",(function(e){storeSearchTerm=e.target.value,filterStoresBySearch(storeSearchTerm),currentPage=1,updateStoreListWithSearch()})),e.addEventListener("keydown",(function(t){"Escape"===t.key&&(e.value="",storeSearchTerm="",filteredStoreResults=[],currentPage=1,updateStoreListWithSearch())})))}));const originalUpdateStoreList=window.updateStoreList;window.updateStoreList=function(){storeSearchTerm.trim()?updateStoreListWithSearch():originalUpdateStoreList&&originalUpdateStoreList()},document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("settings"),t=document.getElementById("settings-mobile");if(e&&t){function n(){try{t.open||(t.open=!0)}catch{}}n();const a=t.querySelector("summary");a&&a.addEventListener("click",(e=>{e.preventDefault(),n(),t.classList.toggle("is-open")})),document.addEventListener("click",(e=>{try{const a=e.target;if(!a)return;if(t.contains(a))return;t.classList.remove("is-open"),n()}catch{}})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(t.classList.remove("is-open"),n())})),e.addEventListener("toggle",(function(){e.open!==t.open&&(t.open=e.open)})),t.addEventListener("toggle",(function(){t.open!==e.open&&(e.open=t.open)}));const o=()=>{const n=e.querySelector("#toggleDark"),a=t.querySelector("#toggleDarkMobile");n&&a&&(a.checked=n.checked);const o=e.querySelector("#unitSystem"),r=t.querySelector("#unitSystemMobile");o&&r&&(r.value=o.value);const i=e.querySelector("#maxResults"),s=t.querySelector("#maxResultsMobile");i&&s&&(s.value=i.value);const c=e.querySelectorAll("#respLenGroup button"),l=t.querySelectorAll("#respLenGroupMobile button");c.forEach(((e,t)=>{l[t]&&(e.classList.contains("btn-primary")?(l[t].classList.remove("btn"),l[t].classList.add("btn-primary")):(l[t].classList.remove("btn-primary"),l[t].classList.add("btn")))}))},r=()=>{const n=e.querySelector("#toggleDark"),a=t.querySelector("#toggleDarkMobile");n&&a&&(n.checked=a.checked,n.dispatchEvent(new Event("change")));const o=e.querySelector("#unitSystem"),r=t.querySelector("#unitSystemMobile");o&&r&&(o.value=r.value,o.dispatchEvent(new Event("change")));const i=e.querySelector("#maxResults"),s=t.querySelector("#maxResultsMobile");i&&s&&(i.value=s.value,i.dispatchEvent(new Event("change")))};o(),e.addEventListener("change",o),t.addEventListener("change",r);const i=t.querySelector("#returnHomeMobile");i&&i.addEventListener("click",(function(){const t=e.querySelector("#returnHome");t&&t.click()}));const s=t.querySelectorAll("#respLenGroupMobile button");s.forEach((t=>{t.addEventListener("click",(function(n){n.preventDefault(),n.stopPropagation();const a=t.dataset.val;s.forEach((e=>{e.classList.remove("btn-primary"),e.classList.add("btn")})),t.classList.remove("btn"),t.classList.add("btn-primary");e.querySelectorAll("#respLenGroup button").forEach((e=>{e.dataset.val===a?(e.classList.remove("btn"),e.classList.add("btn-primary")):(e.classList.remove("btn-primary"),e.classList.add("btn"))})),localStorage.setItem("resp_len",a)}))}))}}));      
</script></body></html>